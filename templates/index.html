<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot RAG UFRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 1000px;
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .response-box, .chunks-box, .gemini-box {
            background-color: #f0f8ff;
            border: 1px solid #cceeff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            white-space: pre-wrap; /* Preserve formatting */
            text-align: left;
        }
        .chunks-box {
            background-color: #fffbe6;
            border-color: #ffe082;
            font-size: 0.85rem;
        }
        .gemini-box {
            background-color: #e6ffed;
            border-color: #a3e6b4;
        }
        .loading {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container">
        <h1 class="text-3xl font-bold text-center text-blue-700 mb-6">
            ü§ñ Asistente RAG Normativa UFRO
        </h1>
        <p class="text-center text-gray-600 mb-8">
            Consulta sobre reglamentos. La respuesta incluye **fuentes** y una opci√≥n de **simplificaci√≥n** con Gemini.
        </p>

        <!-- Formulario de Consulta -->
        <form id="ragForm" class="flex flex-col gap-4 mb-8">
            <textarea id="prompt" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: ¬øQu√© dice la normativa respecto al acoso o bullying en la universidad?"></textarea>
            <button type="submit" id="submitButton" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-200 flex items-center justify-center">
                <span id="buttonText">Enviar Consulta RAG</span>
                <div id="loader" class="loading hidden ml-2"></div>
            </button>
        </form>

        <!-- √Årea de Resultados -->
        <div id="results" class="space-y-6">
            <!-- Respuesta RAG -->
            <div id="ragResponseContainer" class="hidden">
                <h2 class="text-xl font-semibold text-gray-700">Respuesta RAG:</h2>
                <div id="ragResponse" class="response-box text-gray-800"></div>
                
                <p class="text-sm text-gray-500 mt-2">Fuentes: <span id="sourcesList" class="font-medium text-blue-600"></span></p>

                <div class="mt-4 flex flex-col md:flex-row gap-2">
                    <button id="simplifyButton" onclick="simplifyWithGemini()" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-200 flex items-center justify-center">
                        <span id="simplifyButtonText">Simplificar Respuesta con Gemini ‚ú®</span>
                        <div id="simplifyLoader" class="loading hidden ml-2"></div>
                    </button>
                    <button id="toggleChunksButton" onclick="toggleChunks()" class="bg-gray-400 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-500 transition duration-200">
                        Mostrar Fragmentos Recuperados
                    </button>
                </div>
            </div>

            <!-- Fragmentos Recuperados (para debug) -->
            <div id="chunksContainer" class="hidden">
                <h2 class="text-lg font-semibold text-gray-700 mt-4">Fragmentos de Contexto (Debug):</h2>
                <div id="retrievedChunks" class="chunks-box text-gray-700"></div>
            </div>

            <!-- Respuesta de Simplificaci√≥n de Gemini -->
            <div id="geminiResponseContainer" class="hidden mt-6">
                <h2 class="text-xl font-semibold text-gray-700">Explicaci√≥n Simplificada (Gemini):</h2>
                <div id="geminiResponse" class="gemini-box text-gray-800"></div>
            </div>

             <!-- Mensajes de Error -->
            <div id="errorMessage" class="text-center text-red-600 hidden p-3 bg-red-100 border border-red-400 rounded-lg"></div>
        </div>
    </div>

    <script>
        // Variables globales para la API Key de Gemini (se mantiene vac√≠a, Canvas la inyecta)
        const GEMINI_API_KEY = ""; 
        const API_URL = "http://127.0.0.1:5000/query";
        const MODEL = "gemini-2.5-flash-preview-05-20";

        // Referencias de UI
        const ragForm = document.getElementById('ragForm');
        const promptInput = document.getElementById('prompt');
        const submitButton = document.getElementById('submitButton');
        const buttonText = document.getElementById('buttonText');
        const loader = document.getElementById('loader');
        const ragResponseContainer = document.getElementById('ragResponseContainer');
        const ragResponse = document.getElementById('ragResponse');
        const sourcesList = document.getElementById('sourcesList');
        const retrievedChunks = document.getElementById('retrievedChunks');
        const chunksContainer = document.getElementById('chunksContainer');
        const errorMessageDiv = document.getElementById('errorMessage');

        // Botones de funciones
        const simplifyButton = document.getElementById('simplifyButton');
        const simplifyButtonText = document.getElementById('simplifyButtonText');
        const simplifyLoader = document.getElementById('simplifyLoader');
        const geminiResponseContainer = document.getElementById('geminiResponseContainer');
        const geminiResponse = document.getElementById('geminiResponse');
        
        // Estado del RAG
        let lastRagResponseText = ""; // Almacena la respuesta RAG para simplificarla

        // --- Funciones de Utilidad ---

        function setLoading(isLoading, elementId = 'rag') {
            const button = elementId === 'rag' ? submitButton : simplifyButton;
            const textElement = elementId === 'rag' ? buttonText : simplifyButtonText;
            const loaderElement = elementId === 'rag' ? loader : simplifyLoader;

            button.disabled = isLoading;
            if (isLoading) {
                textElement.classList.add('hidden');
                loaderElement.classList.remove('hidden');
            } else {
                textElement.classList.remove('hidden');
                loaderElement.classList.add('hidden');
            }
        }

        function displayError(message) {
            errorMessageDiv.textContent = message;
            errorMessageDiv.classList.remove('hidden');
            ragResponseContainer.classList.add('hidden');
            chunksContainer.classList.add('hidden');
            geminiResponseContainer.classList.add('hidden');
        }

        function toggleChunks() {
            chunksContainer.classList.toggle('hidden');
            const button = document.getElementById('toggleChunksButton');
            if (chunksContainer.classList.contains('hidden')) {
                button.textContent = "Mostrar Fragmentos Recuperados";
            } else {
                button.textContent = "Ocultar Fragmentos Recuperados";
            }
        }
        
        // --- L√ìGICA RAG (LLAMADA A FLASK BACKEND) ---

        ragForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorMessageDiv.classList.add('hidden');
            ragResponseContainer.classList.add('hidden');
            chunksContainer.classList.add('hidden');
            geminiResponseContainer.classList.add('hidden');

            const prompt = promptInput.value.trim();
            if (!prompt) {
                displayError("Por favor, ingresa una consulta.");
                return;
            }

            setLoading(true, 'rag');

            try {
                const payload = { prompt: prompt };
                
                // Implementaci√≥n de Backoff Exponencial
                const MAX_RETRIES = 3;
                let response = null;
                for (let i = 0; i < MAX_RETRIES; i++) {
                    try {
                        response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) break; // √âxito
                        
                        // Si es un error 503 o 500, esperamos y reintentamos
                        if (response.status === 503 || response.status >= 500) {
                            if (i < MAX_RETRIES - 1) {
                                await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                                continue;
                            }
                        }
                        
                        // Si no es un error de servidor (ej: 400 Bad Request), salimos
                        break;

                    } catch (fetchError) {
                        if (i < MAX_RETRIES - 1) {
                            await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                        } else {
                            throw fetchError;
                        }
                    }
                }

                if (!response.ok) {
                    const errorJson = await response.json();
                    throw new Error(errorJson.error || `Error HTTP: ${response.status}`);
                }

                const result = await response.json();
                
                // Mostrar respuesta principal
                ragResponse.textContent = result.response || "No se recibi√≥ respuesta.";
                lastRagResponseText = result.response || "";
                ragResponseContainer.classList.remove('hidden');
                
                // Mostrar fuentes
                sourcesList.textContent = result.sources && result.sources.length > 0
                    ? result.sources.join(' | ')
                    : 'Ninguna citaci√≥n directa.';
                
                // Mostrar chunks de debug
                retrievedChunks.textContent = result.retrieved_chunks 
                    ? result.retrieved_chunks.map((chunk, index) => `[${index + 1}] ${chunk}`).join('\n---\n') 
                    : 'No se recuperaron fragmentos.';

            } catch (error) {
                console.error("Fallo la consulta RAG:", error);
                displayError(`Fallo en el servidor o la red: ${error.message}.`);
            } finally {
                setLoading(false, 'rag');
            }
        });

        // --- L√ìGICA DE GEMINI (CLIENTE-SIDE) ---

        async function simplifyWithGemini() {
            if (!lastRagResponseText) {
                displayError("No hay una respuesta RAG que simplificar.");
                return;
            }

            // Ocultar mensaje de error de RAG y mostrar la caja de Gemini
            errorMessageDiv.classList.add('hidden');
            geminiResponseContainer.classList.remove('hidden');
            geminiResponse.innerHTML = '<p class="text-gray-500">Simplificando con Gemini...</p>';
            setLoading(true, 'simplify');

            const systemPrompt = "Act√∫a como un profesor universitario. Simplifica el siguiente texto t√©cnico sobre normativa o reglas para que sea comprensible para un estudiante de primer a√±o. Usa vi√±etas o listas cuando sea apropiado y mant√©n el tono amigable.";
            const userQuery = `Texto a simplificar:\n---\n${lastRagResponseText}`;
            
            // La llamada a Gemini no usa Google Search Grounding.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${GEMINI_API_KEY}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };
            
            try {
                // Implementaci√≥n de Backoff Exponencial para Gemini
                const MAX_RETRIES = 3;
                let response = null;
                for (let i = 0; i < MAX_RETRIES; i++) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        if (response.ok) break;

                        if (response.status === 500 || response.status === 503) {
                            if (i < MAX_RETRIES - 1) {
                                await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                                continue;
                            }
                        }
                        break;

                    } catch (fetchError) {
                        if (i < MAX_RETRIES - 1) {
                            await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                        } else {
                            throw fetchError;
                        }
                    }
                }

                if (!response.ok) {
                    throw new Error(`Error ${response.status} de la API de Gemini.`);
                }

                const result = await response.json();
                const geminiText = result.candidates?.[0]?.content?.parts?.[0]?.text || "No se pudo generar una explicaci√≥n simplificada.";

                // Mostrar el resultado de Gemini
                geminiResponse.textContent = geminiText; 

            } catch (error) {
                console.error("Error al llamar a Gemini:", error);
                geminiResponse.textContent = `Error al simplificar: ${error.message}`;
                geminiResponse.classList.add('text-red-500');
            } finally {
                setLoading(false, 'simplify');
            }
        }
    </script>
</body>
</html>
